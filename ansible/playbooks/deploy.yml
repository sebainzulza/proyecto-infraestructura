---
- name: Desplegar API Laravel en AWS EC2
  hosts: "{{ target_host }}"
  become: yes
  gather_facts: yes

  vars:
    app_directory: /var/www/app
    docker_compose_file: docker-compose.prod.yml
    docker_image: "{{ image_tag }}"

  tasks:
    - name: Verificar que Docker está instalado
      command: docker --version
      register: docker_check
      failed_when: docker_check.rc != 0
      changed_when: false

    - name: Verificar que Docker Compose está instalado
      command: docker compose version
      register: compose_check
      failed_when: compose_check.rc != 0
      changed_when: false

    - name: Crear directorio de trabajo
      file:
        path: "{{ app_directory }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copiar archivo docker-compose al servidor
      copy:
        src: "../../{{ docker_compose_file }}"
        dest: "{{ app_directory }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copiar configuración de Nginx al servidor
      copy:
        src: "../../docker/nginx/nginx.conf"
        dest: "{{ app_directory }}/nginx.conf"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Crear archivo .env para docker-compose
      copy:
        dest: "{{ app_directory }}/.env"
        content: |
          IMAGE_TAG={{ docker_image }}
          APP_ENV=production
          APP_DEBUG=false
          DB_DATABASE=laravel
          DB_USERNAME=laravel_user
          DB_PASSWORD={{ lookup('env', 'DB_PASSWORD') | default('ChangeMe123!', true) }}
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Login en Docker Hub
      docker_login:
        username: "{{ lookup('env', 'DOCKER_USERNAME') }}"
        password: "{{ lookup('env', 'DOCKER_PASSWORD') }}"
        registry: docker.io
      no_log: true

    - name: Pull de la imagen Docker desde Docker Hub
      docker_image:
        name: "{{ docker_image }}"
        source: pull
        force_source: yes

    - name: Detener contenedores existentes
      community.docker.docker_compose_v2:
        project_src: "{{ app_directory }}"
        state: absent
      ignore_errors: yes

    - name: Levantar aplicación con Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ app_directory }}"
        state: present
        pull: "always"
        recreate: always
        remove_orphans: yes
      environment:
        IMAGE_TAG: "{{ docker_image }}"

    - name: Esperar a que la aplicación esté lista
      wait_for:
        port: 8080
        delay: 10
        timeout: 60

    - name: Ejecutar migraciones de base de datos
      docker_container:
        name: laravel-migrate
        image: "{{ docker_image }}"
        command: php artisan migrate --force
        networks:
          - name: app_network
        env:
          APP_ENV: production
          DB_HOST: db
          DB_DATABASE: laravel
          DB_USERNAME: laravel_user
          DB_PASSWORD: "{{ lookup('env', 'DB_PASSWORD') | default('ChangeMe123!', true) }}"
        detach: no
        cleanup: yes
        auto_remove: yes

    - name: Verificar estado de los contenedores
      command: docker compose ps
      args:
        chdir: "{{ app_directory }}"
      register: container_status
      changed_when: false

    - name: Mostrar estado de los contenedores
      debug:
        var: container_status.stdout_lines

    - name: Health check de la API
      uri:
        url: "http://localhost:8080/api/servers"
        method: GET
        status_code: 200
        timeout: 30
      retries: 3
      delay: 5
      register: health_check

    - name: Despliegue exitoso
      debug:
        msg: "¡Despliegue completado exitosamente! API disponible en http://{{ ansible_host }}:8080"







